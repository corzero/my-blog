---
title: 1.架构
date: 2021-01-01 01:13
---

## 前言

在过去的十年里，互联网发展飞速，网络渐渐变成大家认识世界的窗口，浏览器也在这十年里发生里翻天覆地的变化。作为前端工程狮的我们，也在这互联网浪潮中为大众贡献自己的一份力量。而无论我们是要设计好看且复杂的高性能web应用或者被逼优化手中的成年包浆老代码时，我们都需要尽可能的了解浏览器的原理亦或者安全方面的知识，才能让我们在开发或优化中能游刃有余，从容不迫。

为此，我希望包括我在内的前端工程师能够真正掌握浏览器的知识，能够吃下浏览器这块硬骨头，对浏览器有个全新的认识。


## 一张图

<img :src="$withBase('/image/浏览器任务管理器.png')" alt="浏览器任务管理器"/>

打开你的chrome浏览器或者Edge的任务管理器（我不想打开IE，IE快要淘汰啦，本文讲述的都是新时代浏览器哦😁），你会发现只打开了一个空白页有很多个进程。小小的脑袋，大大的疑惑🤔。那么有人会问：为什么浏览器需要这些进程呢？每个进程的作用是什么呢？ 别着急，在回答这些问题前，需要了解两个概念：

1. 线程（Thread）：操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务

2. 进程（Process）：计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。

阮大有介绍哦 戳👉[进程和线程的解释](http://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html)

了解这两个概念之后，我们再回头看看现代的浏览器。

## 远古时代的浏览器与现代浏览器

### 远古时代

其实早在十年前，大多数的浏览器都是单进程的，也就是说 单进程浏览器是指浏览器的所有功能模块都是运⾏在同⼀个进程⾥。包含了⽹络、插件、JS运⾏环境、渲染引擎和⻚⾯等。单进程浏览器架构如下图所⽰：

<img :src="$withBase('/image/单进程浏览器架构.png')" alt="单进程浏览器架构"/>

可以看到单进程上运行这么多功能，在面对大量复杂交互或任务时，不同功能相互切换，会导致卡顿甚至崩溃，缺点也非常突出：

1. 不流畅：因为是单进程，那么如果某个任务长时间运行，无法切换其他功能模块，则会卡住或崩溃。如下
```js
    while(true){
        console.log('卡住了💔')
    }
```

2. 不稳定：早期浏览器需要借助于插件来实现诸如Web视频、Web游戏等各种强⼤的功能，但是插件是最容易出问题的模块，并且还运⾏在浏览器进程之中，所以⼀个插件的意外崩溃会引起整个浏览器的崩溃。

3. 不安全：插件可以使⽤C/C++等代码编写，通过插件可以获取到操作系统的任意资源，也就意味着装上这个插件就能完全操作你的电脑。如果是个恶意插件，那么它就可以释放病毒、窃取账号密码，出现安全性问题。

但早期的页面并没有特别多的功能，所以还是可以用。而后面十年是互联网发展的黄金时期，页面越来越多样化，浏览器也在进化。


### 新时代

在十年前，有个精神小伙G，不满IE老家伙的占据市场（主要是微软占据市场后不死进取，守旧。）这个精神小伙G认为如果要实现Web 2.0，世界需要一些新的东西，颠覆现有认知的技术。于是Google从头开始重新思考浏览器的整个概念，并在2008年时正式发布了Chrome浏览器的测试版，并将chromium开源，从此精神小伙在这条路上越走约远，国内很多的浏览器都是套用的Google开源的chromium，更好笑的微软在推出自家Edge浏览器后又将其内核正式替换为chromium。[发展历史戳👉](https://www.huxiu.com/article/312327.html)

当前世界浏览器格局主要是还是Chrome和Firefox及Safari等。而新版的浏览器架构如下：（架构基本相似哦）

<img :src="$withBase('/image/新版浏览器架构.png')" alt="新版浏览器架构"/>

看图知道，Chrome的⻚⾯是运⾏在单独的渲染进程中的，同时⻚⾯⾥的插件也是运⾏在单独的插件进程之中，⽽进程之间是通过IPC机制进⾏通信（如图中虚线部分）。

**我们再看看它是如何解决远古时代浏览器的问题的**

1. 流畅：JS也是运⾏在渲染进程中的，所以即使JS阻塞了渲染进程，影响到的也只是当前的渲染⻚⾯，⽽并不会影响浏览器和其他⻚⾯，因为其他⻚⾯的脚本是运⾏在它们⾃⼰的渲染进程中的。所以当我们再在Chrome中运⾏上⾯那个死循环的脚本时，没有响应的仅仅是当前的⻚⾯。而对于内存泄漏的解决⽅法，因为当关闭⼀个⻚⾯时，整个渲染进程也会被关闭，之后该进程所占⽤的内存都会被系统回收，这样就不存在内存泄漏问题了。

2. 稳定：由于进程是相互隔离的，所以当⼀个⻚⾯或者插件（第一个图中的Proxy Switchy就是一个插件，这也是个单独进程）崩溃时，影响到的仅仅是当前的⻚⾯进程或者插件进程，并不会影响到浏览器和其他⻚⾯，这就完美地解决了⻚⾯或者插件的崩溃会导致整个浏览器崩溃，也就是不稳定的问题。

3. 安全：由于采⽤多进程架构，他的额外好处是可以使⽤安全沙箱，我们把沙箱看成是操作系统给进程上了⼀把锁，沙箱⾥⾯的程序可以运⾏，但是不能在硬盘上写⼊任何数据，也不能在敏感位置读取任何数据。Chrome把插件进程和渲染进程锁在沙箱⾥⾯，这样即使在渲染进程或者插件进程⾥⾯执⾏了恶意程序，恶意程序也⽆法突破沙箱去获取系统权限。

有人会问：诶不对啊你这图和第一个图不匹配呀，别着急，这张图只是告诉你目前浏览器的基本架构是多进程的，Chrome在这十年也在不停发展，架构也在优化，下面是最新的架构图：

<img :src="$withBase('/image/最新chrome架构.png')" alt="最新chrome架构"/>

+ **浏览器进程**: 主要负责界⾯显⽰、⽤户交互、⼦进程管理，同时提供存储等功能。
+ **渲染进程**: 核⼼任务是将 HTML、CSS 和 JS 转换为⽤户可以与之交互的⽹⻚，排版引擎Blink和JS引擎V8都是运⾏在该进程中，默认情况下，Chrome会为每个Tab标签创建⼀个渲染进程。出于安全考虑，渲染进程都是运⾏在沙箱模式下。
+ **GPU进程**: Chrome刚开始发布的时候是没有GPU进程的。⽽GPU的使⽤初衷是为了实现3D CSS的效果，只是随后⽹⻚、Chrome的UI界⾯都选择采⽤GPU来绘制，这使得GPU成为浏览器普遍的需求。最后，Chrome在其多进程架构上也引⼊了GPU进程。
+ **⽹络进程**: 主要负责⻚⾯的⽹络资源加载，之前是作为⼀个模块运⾏在浏览器进程⾥⾯的，直⾄最近才独⽴出来，成为⼀个单独的进程。
+ **插件进程**: 主要是负责插件的运⾏，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和⻚⾯造成影响。


**好家伙！没有缺点么？**

可惜不是的，凡事都有两⾯性，虽然多进程模型提高了浏览器的稳定性、流畅性和安全性，但同样不可避免地带来了⼀些问题：

+ **复杂的架构**: 意味着维护和升级的越来越难，面对新的需求可能会无法满足。
+ **较高的资源占有**: 每个进程都包含公共基础结构的副本（JS运⾏环境等），这也是为啥开了十几个网页占用内存几个G的原因哦。


**怎么面对未来更加复杂多变的需求？**

很好的问题，其实在2016年的时候，Chrome官⽅团队使⽤“⾯向服务的架构”（Services Oriented Architecture，简称SOA）的思想设计了新的Chrome架构。会朝向现代操作系
统所采⽤的“⾯向服务的架构” ⽅向发展，原来的各种模块会被重构成独⽴的服务（Service），每个服务（Service）都可以在独⽴的进程中运⾏，访问服务（Service）必须使⽤定义好的接⼝，通过IPC来通信，从⽽构建⼀个更内聚、松耦合、易于维护和扩展的系统，更好实现 Chrome 简单、稳定、⾼速、安全的⽬标。

<img :src="$withBase('/image/chrome服务架构.png')" alt="chrome服务架构"/>

这些可以简单了解一下，如果想深入的话其实可以看这篇官方文档 👉[Chrome Service Model](https://docs.google.com/document/d/15I7sQyQo6zsqXVNAlVd520tdGaS8FCicZHrN0yRu-oU/edit#)