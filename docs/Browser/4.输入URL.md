---
title: 4.输入URL
date: 2020-05-27
---

## 前言

为什么我要单独将这个问题作为独立章节讲，主要是因为，这个问题在面试的时候太太太太太容易出现了（崩溃😭），但这个属于加分项的问题几乎没有人可以回答的全面和仔细。为什么，因为这个问题包含的知识点非常多，其中涉及到了⽹络、操作系统、Web等⼀系列的知识（非常详细的话大概可以20min）。这个问题也极能体现一个面试者对前端知识的一个梳理和掌握情况。很多人在回答这个问题的时候只是匆匆忙忙，简短回答，但需要知道，越这样面试官会觉得你在这块知识掌握程度不够，就会追着问这些深入的问题（害怕🐶）。

## 一张图

<img :src="$withBase('/image/url流程1.png')" alt="url流程1"/>

看这个图之前如果没有了解浏览器，会有点迷糊，所以这里快速回顾一下知识点：
+ 浏览器进程主要负责⽤户交互、⼦进程管理和⽂件储存等功能。
+ ⽹络进程是⾯向渲染进程和浏览器进程等提供⽹络下载功能。
+ 渲染进程的主要职责是把从⽹络下载的HTML、JavaScript、CSS、图⽚等资源解析为可以显⽰和交互的⻚⾯。因为渲染进程所有的内容都是通过⽹络获取的，会存在⼀些恶意代码利⽤浏览器漏洞对系统进⾏攻击，所以运⾏在渲染进程⾥⾯的代码是不被信任的。这也是为什么Chrome会让渲染进程运⾏在安全沙箱⾥，就是为了保证系统的安全。

### 导航

+ 用户输入URL到浏览器

+ ⽹络进程发起URL请求

+ 服务器响应URL请求之后，浏览器进程就⼜要开始准备渲染进程。

+ 渲染进程准备好之后，需要先向渲染进程提交⻚⾯数据，即提交⽂档阶段。

+ 渲染进程接收完⽂档信息之后，开始解析⻚⾯和加载⼦资源，完成⻚⾯的渲染。

### 从输⼊URL到⻚⾯展⽰

1. **用户输入**   

    当⽤户在地址栏中输⼊⼀个查询关键字时，地址栏会判断输⼊的关键字是**搜索内容**，还是**请求的URL**。
    + 当⽤户输⼊关键字并键⼊回⻋之后，浏览器便进⼊下图的状态： 开始加载URL浏览器状态 如果是搜索内容，地址栏会使⽤浏览器默认的搜索引擎，来合成新的带搜索关键字的URL。 
    + 如果判断输⼊内容符合URL规则，⽐如输⼊的是`www.baidu.com`，那么地址栏会根据规则，把这段内容加上协议，合成为完整的URL:`https://www.baidu.com`

    当⽤户输⼊关键字并键⼊回⻋之后，浏览器便进⼊下图的状态：
    <br />
    <img :src="$withBase('/image/url流程2.png')" alt="url流程2"/>

    从图中可以看出，当浏览器刚开始加载⼀个地址之后，标签⻚上的图标便进⼊了加载状态。但此时图中⻚⾯显⽰的依然是之前打开的⻚⾯内容，并没⽴即替换为百度的⻚⾯。因为需要等待提交⽂档阶段，⻚⾯内容才会被替换。
    
2. **URL请求过程**

    接下来，便进⼊了⻚⾯资源请求过程。这时，浏览器进程会通过进程间通信（IPC）把URL请求发送⾄⽹络进程，⽹络进程接收到URL请求后，会在这⾥发起真正的URL请求流程。那具体流程是怎样的呢？

    ⾸先，⽹络进程检查当前队列是否有空余，如果没有则会等待当前队列释放后派发任务到队列中，队列任务开始执行时会**检查本地缓存**是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接进⼊⽹络请求流程。这请求前的第⼀步是要进⾏**DNS解析**，以获取请求域名的服务器IP地址，同样先检查**浏览器DNS缓存及操作系统DNS缓存**。如果请求协议是HTTPS，那么还需要建⽴<b>TLS(SSL)</b>连接（HTTPS后面会补充）。

    然后就是利⽤IP地址和服务器建⽴TCP连接（三次握手🤝）。连接建⽴之后，浏览器端会构建请求⾏、请求头等信息，并把和该域名相关的Cookie、自定义头信息等数据附加到请求头中，然后向服务器发送构建的请求信息。

    服务器接收到请求后，会根据请求信息处理内容然后返回响应数据（包括响应⾏、响应头和响应体等信息），并发给⽹络进程。等⽹络进程接收了响应⾏和响应头之后，就开始解析响应头的内容了（nginx的HTTP1.1版本中`Keep-Alive`默认时常60s，60s内复用当前TCP，超过则断开当TCP连接（4次挥手🙋））。

    <br />

    **那么有人会问浏览器是如何知道服务器返回的内容是什么呢？**

    答案是：`Content-Type`，查看👉 [完整的Content-Type](https://tool.oschina.net/commons)

    `Content-Type`是HTTP头中⼀个⾮常重要的字段， 它告诉浏览器服务器返回的响应体数据是什么类型，然后浏览器会根据`Content-Type`的值来决定**如何显⽰响应体的内容**。

    像我们常见的网页，`Content-Type`为`text/html;charset=utf-8`,如果是下载的文件`Content-Type`为`application/octet-stream`,

    如果服务器配置`Content-Type`不正确，如`text/html`配置成`text/plain`，那么浏览器可能会将一个本来要渲染的html文件当中txt文件直接显示内容到页面上。不同Content-Type的后续处理流程也截然不同。如果返回的是HTML，那么浏览器还会准备渲染进程，准备渲染页面。


    <font color=red size=3>*注意</font>：服务器返回响应后，⽹络进程开始解析响应头，如果发现返回的状态码是301或者302，那么说明服务器需要浏览器重定向到其他URL。这时⽹络进程会从响应头的`Location`字段⾥⾯读取重定向的地址，然后再发起新的HTTP或者HTTPS请求，⼀切⼜重头开始了。



3. **渲染进程**  

    默认情况下，Chrome会为每个⻚⾯分配⼀个渲染进程，也就是说，每打开⼀个新⻚⾯就会配套创建⼀个新的渲染进程。但是，也有⼀些例外，在某些情况下，浏览器会让多个⻚⾯直接运⾏在同⼀个渲染进程中。其实为了节省内存，Chrome提供了四种进程模式(Process Models)，不同的进程模式会对 tab 进程做不同的处理。  

    **site**：协议及根域名相同即为同一网站。  

    **site-instance**：满足点击打开或者js打开的页面且新开页面满足site定义，那么这两个页面属于同一site-instance   

    + Process-per-site-instance (default) - 同一个 site-instance 使用一个进程。
    + Process-per-site - 同一个 site 使用一个进程。
    + Process-per-tab - 每个 tab 使用一个进程。
    + Single process - 所有 tab 共用一个进程


    **通俗来讲，点击页面中的某个链接或通过js打开的，且该链接的地址协议及根域名与当前相同，那么则新开页面与当前页面共享渲染进程。**  

    当渲染进程准备好了，并不能⽴即进⼊⽂档解析状态，主要是因为⽂档数据还在⽹络进程中，并没有通过IPC提交给渲染进程，所以下⼀步就进⼊了提交⽂档阶段。  

4. **提交⽂档**  

    **⽂档**：URL请求的响应体数据   

    + “提交⽂档”的消息是由浏览器进程发出的，渲染进程接收到“提交⽂档”的消息后，会通过IPC管道与⽹络进程传输数据。

    + 等⽂档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程。

    + 浏览器进程在收到“确认提交”的消息后，会更新浏览器界⾯状态，包括了安全状态、地址栏的URL、前进后退的历史状态，并更新Web⻚⾯。

    <img :src="$withBase('/image/url流程3.png')" alt="url流程3" height="400"/>   

5. **渲染阶段<font color=red size=3>（非常非常非常重要！！！！！！！）</font>**   

    ⼀旦⽂档被提交，渲染进程便通过解析HTML，构建DOM树、样式计算、布局、分层、绘制、分块、光栅化和合成等将网页呈现出来。

    就这？？？当然不是，先休息一会～🐶




