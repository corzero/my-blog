---
title: 19.DOM🌲
date: 2020-05-29
---

## 前言
我们在面试过程中都会遇到一个常见的面试题目，那就是———浏览器DOM树是怎么⽣成的。有些同学就是啪的一下，很快啊，面试官还没反应过来，就把之前的八股文背出来了。面试官说，你这年轻人不讲面得，欺负人家。后来就是面试官追着你的八股文去深究DOM的构建，试探你的深度，最后自己才是小丑。其实一直都是这样，在面试的时候，面试官几乎都是先从一个简单的或者常见的问题开始，面试官更喜欢，那些出了个问题就知道面试官真正想要听到答案的面试者，主动出击，其实是一个加分项，当然，时刻要注意你的回答，因为常常面试官喜欢跟着你的回答继续深挖，这里就是仁者见仁智者见智了，好了，说了这么多，八股文我们都背烂了，那么DOM到底怎么构建的？我们好好分析一下

## DOM是什🐎？
从⽹络传给渲染引擎的HTML⽂件字节流是⽆法直接被渲染引擎理解的，所以要将其转化为渲染引擎能够理解的内部结构，这个结构就是DOM。DOM提供了对HTML⽂档结构化的表述。在渲染引擎中，DOM有三个层⾯的作⽤。DOM是表述HTML的内部数据结构，它会将Web⻚⾯和JavaScript脚本连接起来，并过滤⼀些不安全的内容。

+ DOM是⽣成⻚⾯的基本结构。
+ DOM提供给JS脚本操作的接⼝，从⽽改变⽂档的结构、样式和内容。
+ DOM是⼀道安全防护线，⼀些不安全的内容在DOM解析阶段就被拒之⻔外了。

## DOM树如何⽣成?

在渲染引擎内部，有⼀个叫**HTML解析器（HTMLParser）**的模块，它的职责就是负责将**HTML字节流转换为DOM结构**。所以这⾥我们需要先要搞清楚HTML解析器是怎么⼯作的。

HTML解析器并不是等整个⽂档加载完成之后再解析的，⽽是**⽹络进程加载了多少数据，HTML解析器便解析多少数据**。

那详细的流程是怎样的呢？
1. ⽹络进程接收到响应头之后，会根据请求头中的content-type字段来判断⽂件的类型，⽐如content-type的值是“text/html”，那么浏览器就会判断这是⼀个HTML类型的⽂件，然后为该请求选择或者创建⼀个渲染进程。
2. 渲染进程准备好之后，⽹络进程和渲染进程之间会建⽴⼀个共享数据的管道，⽹络进程接收到数据后就传入这个流管道，⽽渲染进程则从管道的另外⼀端不断地读取数据，并同时将读取的数据给HTML解析器。
3. ⽹络进程接收到的字节流，一点点的传给渲染进程的HTML解析器，它会动态接收字节流，并将其解析为DOM。

代码从⽹络传输过来是字节流的形式，后续字节流转换为DOM的流程如下：

<img :src="$withBase('/image/字节流转DOM.png')" alt="字节流转DOM" height="300"/>

细分图后大概流程分为三步：

1. **通过分词器将字节流转换为Token**

V8编译JavaScript过程中的第⼀步是做词法分析，将JavaScript先分解为⼀个个Token。解析HTML也是⼀样的，需要通过分词器先将字节流转换为⼀个个Token，分为Tag Token和⽂本Token。上述HTML代码通过词法分析⽣成的Token如下所⽰：

<img :src="$withBase('/image/生成Token.png')" alt="生成Token" />

由图可以看出，Tag Token⼜分StartTag 和 EndTag，⽐如`<body>`就是StartTag ，`</body>`就是EndTag，分别对于图中的蓝⾊和红⾊块，⽂本Token对应的绿⾊块。

**⾄于后续的第⼆个和第三个阶段是同步进⾏的，需要将Token解析为DOM节点，并将DOM节点添加到DOM树中。**

+ HTML解析器维护了⼀个Token栈结构，该Token栈主要⽤来计算节点之间的⽗⼦关系，在第⼀个阶段中⽣成的Token会被按照顺序压到这个栈中。具体的处理规则如下所⽰：

+ 如果压⼊到栈中的是StartTag Token，HTML解析器会为该Token创建⼀个DOM节点，然后将该节点加⼊到DOM树中，它的⽗节点就是栈中相邻的那个元素⽣成的节点。

+ 如果分词器解析出来是⽂本Token，那么会⽣成⼀个⽂本节点，然后将该节点加⼊到DOM树中，⽂本Token是不需要压⼊到栈中，它的⽗节点就是当前栈顶Token所对应的DOM节点。

+ 如果分词器解析出来的是EndTag标签，⽐如是EndTag div，HTML解析器会查看Token栈顶的元素是否是StarTag div，如果是，就将StartTag div从栈中弹出，表⽰该div元素解析完成。

通过分词器产⽣的新Token就这样不停地压栈和出栈，整个解析过程就这样⼀直持续下去，直到分词器将所有字节流分词完成。



