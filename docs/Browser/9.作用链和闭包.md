---
title: 9.作用链和闭包
date: 2020-05-29
---

# 前言
理解作⽤域链是理解闭包的基础，⽽闭包在JS中⼏乎⽆处不在，同时作⽤域和作⽤域链还是所有编程语⾔的基础。所以，作⽤域和作⽤域链⼀定是绕不开的。
这篇文章主要帮助我们了解什么是作⽤域链，并通过作⽤域链再来讲讲什么是闭包。

## 执⾏流程

```js 
function bar() {
    console.log(myName)
}

function foo() {
    var myName = "啊哈啊哈"
    bar()
}

var myName = "阿巴阿巴"

foo()
```

能看出这段代码中的bar函数和foo函数打印出来的内容是什么？其实这些内容的分析主要依赖其代码的执行流程了。

<img :src="$withBase('/image/作用域链1.png')" alt="作用域链1"  height='400'/>

从图中可以看出，全局执⾏上下⽂和foo函数的执⾏上下⽂中都包含变量`myName`，那bar函数⾥⾯`myName`的值到底该选择哪个呢？

可能第⼀反应是按照调⽤栈的顺序来查找变量，查找⽅式如下：

1. 先查找栈顶是否存在`myName`变量，但是这⾥没有，所以接着往下查找foo函数中的变量。
2. 在foo函数中查找到了`myName`变量，这时候就使⽤foo函数中的`myName`。

如果按照这种⽅式来查找变量，那么最终执⾏bar函数打印出来的结果就应该是“啊哈啊哈”。但实际情况并⾮如此，如果你试着执⾏上述代码，你会发现打印出来的结果是“阿巴阿巴”。为什么会是这种情况呢？要解释清楚这个问题，那么你就需要先搞清楚作⽤域链了。

## 作⽤域链

关于作⽤域链，很多⼈会感觉费解，但如果你理解了调⽤栈、执⾏上下⽂、词法环境、变量环境等概念，那么你理解起来作⽤域链也会很容易。所以很是建议你结合前⼏篇⽂章将上⾯那⼏个概念学习透彻。

其实在每个执⾏上下⽂的变量环境中，都包含了⼀个外部引⽤，⽤来指向外部的执⾏上下⽂，我们把这个外部引⽤称为`outer`。

当⼀段代码使⽤了⼀个变量时，JS引擎⾸先会在“当前的执⾏上下⽂”中查找该变量，⽐如上⾯那段代码在查找`myName`变量时，如果在当前的变量环境中没有查找到，那么JS引擎会继续在`outer`所指向的执⾏上下⽂中查找。为了直观理解，你可以看下⾯这张图：

<img :src="$withBase('/image/作用域链2.png')" alt="作用域链2"  height='400'/>

从图中可以看出，bar函数和foo函数的outer都是指向全局上下⽂的，这也就意味着如果在bar函数或者foo函数中使⽤了外部变量，那么JS引擎会去全局执⾏上下⽂中查找。我们把这个查找的链条就称为**作⽤域链**。

现在你知道变量是通过作⽤域链来查找的了，不过还有⼀个疑问没有解开，foo函数调⽤的bar函数，那为什么bar函数的外部引⽤是全局执⾏上下⽂，⽽不是foo函数的执⾏上下⽂？

要回答这个问题，你还需要知道什么是**词法作⽤域**。这是因为在JS执⾏过程中，其作⽤域链是由词法作⽤域决定的。

## 词法作⽤域

**词法作⽤域就是指作⽤域是由代码中函数声明的位置来决定的，所以词法作⽤域是静态的作⽤域，通过它就能够预测代码在执⾏过程中如何查找标识符。**

<img :src="$withBase('/image/作用域链3.png')" alt="作用域链3"  height='400'/>

从图中可以看出，词法作⽤域就是根据代码的位置来决定的，其中main函数包含了bar函数，bar函数中包含了foo函数，因为JS作⽤域链是由词法作⽤域决定的，所以整个词法作⽤域链的顺序是：foo函数作⽤域—>bar函数作⽤域—>main函数作⽤域—>全局作⽤域。

了解了词法作⽤域以及JS中的作⽤域链，我们再回过头来看看上⾯的那个问题：在开头那段代码中，foo函数调⽤了bar函数，那为什么bar函数的外部引⽤是全局执⾏上下⽂，⽽不是foo函数的执⾏上下⽂?

这是因为根据词法作⽤域，foo和bar的上级作⽤域都是全局作⽤域，所以如果foo或者bar函数使⽤了⼀个它们没有定义的变量，那么它们会到全局作⽤域去查找。也就是说，**词法作⽤域是代码阶段就决定好的，和函数是怎么调⽤的没有关系**。

## 块级作⽤域中的变量查找

前⾯我们通过全局作⽤域和函数级作⽤域来分析了作⽤域链，那接下来我们再来看看块级作⽤域中变量是如何查找的？在编写代码的时候，如果使⽤了⼀个在当前作⽤域中不存在的变量，这时JS引擎就需要按照作⽤域链在其他作⽤域中查找该变量，如果不了解该过程，那就会有很⼤概率写出不稳定的代码。

```js
function bar() {
    var myName = "陈冠希"
    let test1 = 100
    if (1) {
        let myName = "Chrome浏览器"
        console.log(test)
    }
}

function foo() {
    var myName = "吴彦祖"
    let test = 2
    {
        let test = 3
        bar()
    }
}

var myName = "彭于晏"
let myAge = 10
let test = 1

foo()
```

